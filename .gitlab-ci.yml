---

stages:
  - build
  - preprod
  - prod

variables:
  CDN_PATH: https://cdn.doyoudreamup.com

preprod:
  stage: preprod
  image: node:14.15.0-alpine
  before_script:
    - npm config set //registry.npmjs.org/:_authToken ${NPM_TOKEN}
    - npm install
    - npm run buildPreprod
  script:
    - apt update
    - apt install -y rsync python3-pip
    - pip3 --no-cache-dir install ansible
    - chmod 0700 .ssh
    - chmod 0600 .ssh/id_ed25519
    - ansible-playbook --inventory hosts.yml deliverPreprod.yml
  only:
    refs:
      - development
      - /project\/.*/

prod:
  stage: prod
  image: node:14.15.0-alpine
  when: manual
  before_script:
    - npm config set //registry.npmjs.org/:_authToken ${NPM_TOKEN}
    - npm install
    - npm run buildProd
  script:
    - apt update
    - apt install -y rsync python3-pip
    - pip3 --no-cache-dir install ansible
    - chmod 0700 .ssh
    - chmod 0600 .ssh/id_ed25519
    - ansible-playbook --inventory hosts.yml deliverProd.yml
  only:
    refs:
      - development
      - /project\/.*/

dydubox:
  stage: build
  image: node:14.15.0-alpine
  tags: 
    - build
  script:
    - npm config set //registry.npmjs.org/:_authToken ${NPM_TOKEN}
    - npm ci --cache .npm --prefer-offline
    - webpack --env $BUILD_TARGET --env sass --env "$CDN_PATH/$BOT_UUID/$CONFIGURATION_UUID/" --config webpack.production.js
    - |
      cat > build/metadata.txt << EOF
      DATE=$(date +"%y%m%d_%H%M")
      BOT_UUID=$BOT_UUID
      CONFIGURATION_UUID=$CONFIGURATION_UUID
      BUILD_TARGET=$BUILD_TARGET
      JOB_ID=$CI_JOB_ID
      CHATBOX_GIT_COMMIT=$CI_COMMIT_SHORT_SHA
      CHATBOX_GIT_REF=$CI_COMMIT_REF_NAME
      EOF
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - .npm
  only:
    variables: 
      - $DYDUBOX_TRIGGER == "true"
      - $CONFIGURATION_UUID
      - $BOT_UUID
      - $BUILD_TARGET
  artifacts:
    expire_in: 15m
    paths:
      - build/**
...
