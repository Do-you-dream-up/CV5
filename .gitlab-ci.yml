---

stages:
  - integration
  - delivery

build:
  stage: integration
  image: node:alpine
  before_script:
    - export CHATBOX_VERSION="${CI_COMMIT_REF_NAME}"
    - export CHATBOX_REVISION="${CI_COMMIT_SHORT_SHA}"
  script:
    - npm ci --cache .npm --prefer-offline
    - npm run build
  cache:
    key: "$CI_COMMIT_REF_SLUG-$CI_COMMIT_SHORT_SHA"
    paths:
      - build/
  rules:
    - if: '$CI_COMMIT_REF_NAME =~ /^(feat|fix|hotfix)_.*/'
    - if: '$CI_COMMIT_REF_NAME =~ /^chatbox_.*/'
    - if: '$CI_COMMIT_REF_NAME =~ /^main_.*/'
  artifacts:
    paths:
      - .npm/_logs/
    expire_in: 24h

pack:
  stage: delivery
  image: alpine:latest
  before_script:
    - apk add zip curl
  script:
    - zip -v -r ${CI_COMMIT_REF_NAME}.zip build/*
    # TODO: use front user/password
    - curl -v -u "${NEXUS_REGISTRY_USER}:${NEXUS_REGISTRY_PASSWORD}" --upload-file "${CI_COMMIT_REF_NAME}.zip" "https://nexus.doyoudreamup.com/repository/front_artefacts/chatbox/${CI_COMMIT_REF_NAME}.zip"
  cache:
    key: "$CI_COMMIT_REF_SLUG-$CI_COMMIT_SHORT_SHA"
    paths:
      - build/
  rules:
    - if: '$CI_COMMIT_REF_NAME =~ /^(feat|fix|hotfix)_.*/'
    - if: '$CI_COMMIT_REF_NAME =~ /^chatbox_.*/'
  needs:
    - build
  when: manual

publish:
  stage: delivery
  image: alpine:latest
  before_script:
    - apk add openssh-client rsync
    - mv -v .ssh ~/ && chmod -v 0700 ~/.ssh && chmod -v 0600 ~/.ssh/id_ed25519
  script:
    - rsync -czrv --progress --delete -e "ssh -p558 -o StrictHostKeyChecking=no" build/* dydu@node1.cdn.dydu-priv.com:/var/opt/docker/volumes/cdn_nginx_www/_data/chatbox/${CI_COMMIT_REF_NAME}/
    - rsync -czrv --progress --delete -e "ssh -p558 -o StrictHostKeyChecking=no" build/* dydu@node2.cdn.dydu-priv.com:/var/opt/docker/volumes/cdn_nginx_www/_data/chatbox/${CI_COMMIT_REF_NAME}/
    - rsync -czrv --progress --delete -e "ssh -p558 -o StrictHostKeyChecking=no" build/* dydu@node3.cdn.dydu-priv.com:/var/opt/docker/volumes/cdn_nginx_www/_data/chatbox/${CI_COMMIT_REF_NAME}/
  cache:
    key: "$CI_COMMIT_REF_SLUG-$CI_COMMIT_SHORT_SHA"
    paths:
      - build/
  rules:
    - if: '$CI_COMMIT_REF_NAME =~ /^(feat|fix|hotfix)_.*/'
    - if: '$CI_COMMIT_REF_NAME =~ /^chatbox_.*/'
  needs:
    - build
  when: manual

...
