---

stages:
  - delivery

deliver:
  stage: delivery
  image: node:latest
  before_script:
    - cp -n public/override/configuration.json.sample public/override/configuration.json
    - cp -n public/override/bot.json.sample public/override/bot.json
    - cp -n public/override/theme.json.sample public/override/theme.json
    - cp -n public/override/style.css.sample public/override/style.css
    - npm install
    - npm run build
  script:
    - apt update
    - apt install -y rsync python3-pip
    - pip3 --no-cache-dir install ansible
    - chmod 0700 .ssh
    - chmod 0600 .ssh/id_ed25519
    - ansible-playbook --inventory hosts.yml deliver.yml
  only:
    refs:
      - master

...
